/* Author: @UnrealSec */
class ContextMenu{constructor(t,e){this.container=t,this.dom=null,this.shown=!1,this.root=!0,this.parent=null,this.submenus=[],this.items=e,this._onclick=(t=>{!this.dom||t.target==this.dom||t.target.parentElement==this.dom||t.target.classList.contains("item")||t.target.parentElement.classList.contains("item")||this.hideAll()}),this._oncontextmenu=(t=>{t.preventDefault(),t.target==this.dom||t.target.parentElement==this.dom||t.target.classList.contains("item")||t.target.parentElement.classList.contains("item")||(this.hideAll(),this.show(t.clientX,t.clientY))}),this._oncontextmenu_keydown=(t=>{93==t.keyCode&&(t.preventDefault(),this.hideAll(),this.show(t.clientX,t.clientY))}),this._onblur=(t=>{this.hideAll()})}getMenuDom(){const t=document.createElement("div");t.classList.add("context");for(const e of this.items)t.appendChild(this.itemToDomEl(e));return t}itemToDomEl(t){const e=document.createElement("div");if(null===t)return e.classList="separator",e;t.hasOwnProperty("color")&&/^#([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t.color.toString())&&(e.style.cssText=`color: ${t.color}`),e.classList.add("item");const s=document.createElement("span");s.classList="label",s.innerText=t.hasOwnProperty("text")?t.text.toString():"",e.appendChild(s),t.hasOwnProperty("disabled")&&t.disabled?e.classList.add("disabled"):e.classList.add("enabled");const n=document.createElement("span");if(n.classList="hotkey",n.innerText=t.hasOwnProperty("hotkey")?t.hotkey.toString():"",e.appendChild(n),t.hasOwnProperty("subitems")&&Array.isArray(t.subitems)&&t.subitems.length>0){const s=new ContextMenu(this.container,t.subitems);s.root=!1,s.parent=this;const n=n=>{if(t.hasOwnProperty("disabled")&&1==t.disabled)return;this.hideSubMenus();const i=this.dom.offsetLeft+this.dom.clientWidth+e.offsetLeft,o=this.dom.offsetTop+e.offsetTop;s.shown?s.hide():s.show(i,o)};this.submenus.push(s),e.classList.add("has-subitems"),e.addEventListener("click",n),e.addEventListener("mousemove",n)}else if(t.hasOwnProperty("submenu")&&t.submenu instanceof ContextMenu){const s=t.submenu;s.root=!1,s.parent=this;const n=n=>{if(t.hasOwnProperty("disabled")&&1==t.disabled)return;this.hideSubMenus();const i=this.dom.offsetLeft+this.dom.clientWidth+e.offsetLeft,o=this.dom.offsetTop+e.offsetTop;s.shown?s.hide():s.show(i,o)};this.submenus.push(s),e.classList.add("has-subitems"),e.addEventListener("click",n),e.addEventListener("mousemove",n)}else e.addEventListener("click",i=>{if(this.hideSubMenus(),!e.classList.contains("disabled"))if(t.hasOwnProperty("onclick")&&"function"==typeof t.onclick){const i={handled:!1,item:e,label:s,hotkey:n,items:this.items,data:t};t.onclick(i),i.handled||this.hide()}else this.hide()}),e.addEventListener("mousemove",t=>{this.hideSubMenus()});return e}hideAll(){!this.root||this.parent?this.parent.hide():this.shown&&(this.hideSubMenus(),this.shown=!1,this.container.removeChild(this.dom),this.parent&&this.parent.shown&&this.parent.hide())}hide(){this.dom&&this.shown&&(this.shown=!1,this.hideSubMenus(),this.container.removeChild(this.dom),this.parent&&this.parent.shown&&this.parent.hide())}hideSubMenus(){for(const t of this.submenus)t.shown&&(t.shown=!1,t.container.removeChild(t.dom)),t.hideSubMenus()}show(t,e){this.dom=this.getMenuDom(),this.dom.style.left=`${t}px`,this.dom.style.top=`${e}px`,this.shown=!0,this.container.appendChild(this.dom)}install(){this.container.addEventListener("contextmenu",this._oncontextmenu),this.container.addEventListener("keydown",this._oncontextmenu_keydown),this.container.addEventListener("click",this._onclick),window.addEventListener("blur",this._onblur)}uninstall(){this.dom=null,this.container.removeEventListener("contextmenu",this._oncontextmenu),this.container.removeEventListener("keydown",this._oncontextmenu_keydown),this.container.removeEventListener("click",this._onclick),window.removeEventListener("blur",this._onblur)}}